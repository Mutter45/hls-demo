<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link
      href="https://web.sdk.qcloud.com/player/tcplayer/release/v5.1.0/tcplayer.min.css"
      rel="stylesheet"
    />
    <!--æ’­æ”¾å™¨è„šæœ¬æ–‡ä»¶-->
    <script src="https://tcplayer-1306264703.cos.ap-nanjing.myqcloud.com/tcplayer/test/hls.min.js"></script>
    <script src="https://web.sdk.qcloud.com/player/tcplayer/release/v5.1.0/tcplayer.v5.1.0.min.js"></script>
    <style>
      .title {
        text-align: center;
        font-size: 20px;
      }
      .container {
        display: flex;
        justify-content: center;
        margin: 20px;
      }
      .operation {
        display: flex;
        justify-content: center;
        button {
          width: 100px;
          height: 40px;
        }
        #play-btn {
          margin-right: 20px;
        }
      }
    </style>
  </head>
  <body>
    <div class="title">hlsæ‹‰æµæµ‹è¯•demo</div>
    <div class="container">
      <video
        id="player-container-id"
        webkit-playsinline
        playsinline
        style="object-fit: cover"
      ></video>
    </div>
    <div class="operation">
      <button id="play-btn">æ’­æ”¾</button>
      <button id="pause-btn">æš‚åœ</button>
    </div>
    <script>
      const playBtn = document.querySelector("#play-btn")
      const pauseBtn = document.querySelector("#pause-btn")
      const liveInfo = {
        answerCount: 3,
        answerDuration: 10,
        answerSwitch: null,
        answerTimingType: 0,
        blackList: [],
        canRecord: 0,
        chartSwitch: 1,
        countdownSwitch: 1,
        couponModelId: null,
        couponNeedSignNumber: 1,
        couponSwitch: 0,
        coverUrl: "https://h5.huacongjian.cn/default-live-cover.jpeg",
        createTime: "2025-04-09 15:16:26",
        endTime: null,
        envelopNeedSignNumber: 1,
        envelopeStatus: false,
        freeDefineEnvelope: 0,
        heatType: 1,
        id: 1181681,
        imStatus: true,
        initFrequent: 0,
        initVisitor: 0,
        integral: 10,
        integralNeedSignNumber: 1,
        integralSwitch: 0,
        isVertical: 0,
        iscloseOnlineNumber: 0,
        isopen: 1,
        likeSwitch: 1,
        linkTag: 0,
        liveChannelConfig: {
          liveChannelType: null,
          pullType: 2,
          pushType: 1,
        },
        liveConditionTaskRuleList: [],
        liveEnvelope: '[{"liveMinute":40,"amount":"0.3"}]',
        liveLogo: "https://h5.huacongjian.cn/default-live-cover.jpeg",
        liveNotice: "å“ˆå“ˆå“ˆ",
        liveQuestion: null,
        liveStatus: 5,
        liveTagId: 0,
        liveTagName: null,
        liveType: 2,
        materialId: 0,
        maxAnswerCount: 3,
        memberShareRecordSwitch: 0,
        minEnvelopeAmount: 0.1,
        name: "è…¾è®¯äº‘cdnæ‹‰æµ",
        newLiveQuestionVO: [
          {
            answer: "B",
            answerCount: 3,
            options: [
              {
                label: "A",
                text: "1",
              },
              {
                label: "B",
                text: "1",
              },
              {
                label: "C",
                text: "1",
              },
              {
                label: "D",
                text: "1",
              },
            ],
            questionId: 90,
            questionNo: 1,
            selected: true,
            title: "1",
          },
        ],
        oriCapacity: null,
        passwd: "666",
        peakNumber: null,
        planStartTime: "2025-04-09 15:16:16",
        playCapacity: null,
        preheatingVideoId: 0,
        preheatingVideoName: null,
        preheatingVideoSwitch: 0,
        preheatingVideoUrl: "",
        pullUrl:
          "https://va-eo.qianguolive.cn/testqg/1181681_qg6hd.m3u8?txSecret=79266dc3784c311c056536366a0f9745&txTime=67F8C1C0",
        punchRelationCouponFlag: 0,
        punchRelationEnvelopFlag: 0,
        punchRelationIntegralFlag: 0,
        punchSwitch: 0,
        punchTimeList: null,
        punchTimes: null,
        pushUrl:
          "rtmp://pushtest.qianguolive.cn/testqg/1181681?txSecret=960296ced48dfa7a70948d5ac23b8db5&txTime=67F8C1C0",
        pwdOpen: false,
        questionCount: 1,
        redOf: "1",
        registrationReplayOpen: 0,
        replayCreateTime: null,
        replayDouble: 1,
        replayEndTime: null,
        replayOpen: 0,
        replayParamJson: null,
        replayStartTime: null,
        replayUrl: "",
        replayVideoDuration: null,
        replayVideoSize: null,
        rewardCouponVOList: [],
        rewardRuleMemberLeveList: null,
        rewardSwitch: 0,
        rewardType: 0,
        sendType: -1,
        shareAgain: 0,
        shareDomain: 1,
        shareOpen: "1",
        shopHoppingSwitch: 0,
        showQuestion: 0,
        showTime: "2025-04-09 15:16:26",
        showTimeType: 1,
        showTopFlag: null,
        signBeepSwitch: 0,
        signDuration: 1,
        startTime: null,
        timePointRewardLifeTime: null,
        timePointRewardRuleList: [],
        topShopId: 1432201,
        topShopName: "jmhåƒæœæ€»åº—",
        topicQuestion: null,
        updateTime: "2025-04-09 15:16:26",
        userTagIds: [],
        videoLength: null,
        videoName: null,
        visibilityType: 0,
        visibleUserTagName: null,
        whiteList: [],
      }
      class Player {
        constructor(options) {
          this.tcplayer = null
          this.licenseUrl =
            "https://license.vod2.myqcloud.com/license/v2/1327837990_1/v_cube.license"
          // ä¼šå‘˜ä¿¡æ¯
          this.member = {
            memberId: "",
          }
          this.liveInfo = liveInfo
          this.isPlaying = false
          this.iShowObsPlayBtn = true
          this.timer = null
          this.waitingTimer = null
          this.lastDecodedFrame = 0
          this.lastRecordTime = -1
          this.initTCPlayer()
        }
        // hlsé”™è¯¯ç›¸å…³å¤„ç†é€»è¾‘
        errorHlsPlay() {}
        // æ—¥å¿—æäº¤
        aegisInfoAll() {}
        // å±•ç¤ºå°é¢é€»è¾‘
        isShowTCPlayerPoster() {}
        // tcplayeré”™è¯¯å¤„ç†é€»è¾‘
        videoError() {}
        checkQualityInterval() {
          if (!this.liveInfo.pullUrl.startsWith("http")) return
          if (this.timer) {
            clearInterval(this.timer)
          }

          this.timer = setInterval(() => {
            if (!this.tcplayer) {
              clearInterval(this.timer)
              return
            }
            const quality = this.tcplayer.getVideoPlaybackQuality()
            const decodedFrames = quality.totalVideoFrames || 0
            // console.log("å¼€å§‹æ£€æµ‹è§†é¢‘æ‹‰æµè´¨é‡", this.lastDecodedFrame, decodedFrames)
            if (this.lastDecodedFrame === 0 && decodedFrames) {
              this.lastDecodedFrame = decodedFrames
              return
            }
            // console.log(decodedFrames, "decodedFrames", this.tcplayer.paused(), this.lastDecodedFrame, new Date().getTime() - this.lastRecordTime);
            if (this.tcplayer.paused() == false && decodedFrames) {
              if (this.lastDecodedFrame !== decodedFrames) {
                // console.log("è§†é¢‘æ’­æ”¾æ­£å¸¸");
                this.lastDecodedFrame = decodedFrames
                this.lastRecordTime = new Date().getTime()
              } else if (
                this.lastRecordTime !== -1 &&
                new Date().getTime() - this.lastRecordTime > 4000
              ) {
                this.lastDecodedFrame = 0
                this.lastRecordTime = -1
                console.log("hlsåè®®è§†é¢‘æ’­æ”¾å¤±è´¥")
                this.isPlaying = false
                this.iShowObsPlayBtn = true
                this.errorHlsPlay()
                // this.tcplayer && this.tcplayer.src(this.setTCPlayerUrl())
                // this.reStartTCPlayer('hlsé‡è¯•', { hls: 'æ‹‰æµå¤±è´¥' }, 50)
              }
            }
          }, 2000)
        }
        setTCPlayerUrl() {
          const random = Math.floor(Math.random() * 10000)
          return `${this.liveInfo.pullUrl.split("|")[0]}&randomString=${random}`
        }
        initTCPlayer(type) {
          // TCPlayerçš„é…ç½®å‚æ•°
          const options = {
            licenseUrl: this.licenseUrl,
            width: 600,
            height: 400,
            controls: false,
            videoType: "LIVE", // hls åè®®ç›´æ’­
            hlsConfig: {
              maxBufferLength: 3, // å°†ç¼“å†²æ—¶é•¿è®¾ç½®ä¸º 3 ç§’
              maxBufferSize: 20 * 1024 * 1024, // ç¼“å†²åŒºå¤§å°è®¾ç½®ä¸º 20MBï¼Œé¿å…ç¼“å­˜è¿‡å¤šå¯¼è‡´å»¶è¿Ÿ
              maxMaxBufferLength: 5, // æœ€å¤§ç¼“å†²æ—¶é•¿ä¸Šé™è®¾ç½®ä¸º 5 ç§’
              liveSyncDurationCount: 0, // åŒæ­¥åˆ°ç›´æ’­è¾¹ç¼˜çš„æ—¶é•¿ï¼ˆä½¿ç”¨æœ€æ–°åˆ†ç‰‡çš„æ•°é‡ï¼‰ï¼Œå»ºè®®è®¾ç½®ä¸º 1
              maxLiveSyncPlaybackRate: 0,
              enableWorker: true,
              lowLatencyMode: true, // å¯ç”¨ä½å»¶è¿Ÿæ¨¡å¼ï¼Œç¡®ä¿æ’­æ”¾å™¨å¤„ç†ä½å»¶è¿Ÿæµ
            },
            poster: this.liveInfo.coverUrl,
            webrtcConfig: {
              connectRetryCount: 5,
              connectRetryDelay: 0,
              showLog: true,
            },
            sources: [{ src: this.setTCPlayerUrl() }],
          }
          console.log(this.setTCPlayerUrl(), "options")
          // åˆå§‹åŒ–æ’­æ”¾å™¨
          this.tcplayer = TCPlayer(`player-container-id`, options)

          // å½“æ’­æ”¾å™¨èƒ½å¤Ÿå¼€å§‹æ’­æ”¾è§†é¢‘æ—¶è§¦å‘
          this.tcplayer.on("canplay", (e) => {
            this.isShowTCPlayerPoster("block")
            console.log(e, "è§†é¢‘canplay")
          })

          // å¼€å§‹åŠ è½½æ•°æ®æ—¶è§¦å‘
          this.tcplayer.on("loadstart", (e) => {
            this.isShowTCPlayerPoster("block")
            console.log(e, "è§†é¢‘loadstart")
          })

          // å·²åŠ è½½è§†é¢‘çš„ metadata
          this.tcplayer.on("loadedmetadata", (e) => {
            // this.isShowTCPlayerPoster("block");
            console.log(e, "è§†é¢‘loadedmetadata")
            this.checkQualityInterval()
          })

          // æš‚åœæ—¶è§¦å‘
          this.tcplayer.on("pause", (e) => {
            console.log(e, "è§†é¢‘pause")
            this.isPlaying = false
            this.aegisInfoAll(
              "OBSè§†é¢‘--æ’­æ”¾æš‚åœï¼š",
              {
                ["ç±»å‹"]: e.type,
                ["ä¿¡æ¯"]: "æ’­æ”¾æš‚åœ",
              },
              this.member.memberId
            )
          })

          // æ’­æ”¾åœæ­¢ï¼Œä¸‹ä¸€å¸§å†…å®¹ä¸å¯ç”¨æ—¶è§¦å‘
          this.tcplayer.on("waiting", (e) => {
            console.log(e, "è§†é¢‘waiting")
            if (!this.liveInfo.pullUrl.startsWith("http")) return
            clearTimeout(this.waitingTimer)
            this.waitingTimer = setTimeout(() => {
              !this.isPlaying && this.errorHlsPlay()
            }, 10000)
          })

          // å¼€å§‹æ’­æ”¾ï¼Œç”»é¢å¹¶æ²¡æœ‰å¼€å§‹æ¸²æŸ“
          this.tcplayer.on("play", (e) => {
            console.log(e, "è§†é¢‘play")
            this.aegisInfoAll(
              "OBSè§†é¢‘--å¼€å§‹æ’­æ”¾ï¼š",
              {
                ["ä¿¡æ¯"]: "å¼€å§‹æ’­æ”¾",
                ["playerId"]: this.playerId,
                ["TCPlayerå‚æ•°"]: options,
              },
              this.member.memberId
            )
          })

          // å› ç¼“å†²è€Œæš‚åœæˆ–åœæ­¢åæ¢å¤æ’­æ”¾æ—¶è§¦å‘
          this.tcplayer.on("playing", (e) => {
            this.isShowTCPlayerPoster("none")
            console.log(e, "è§†é¢‘playing")
            this.isPlaying = true
            this.iShowObsPlayBtn = false // éšè—æ’­æ”¾æŒ‰é’®
            // this.aegisInfoAll('OBSè§†é¢‘--æ¢å¤æ’­æ”¾ï¼š', {
            // 	['ä¿¡æ¯']: 'æ¢å¤æ’­æ”¾'
            // }, this.member.memberId);
          })

          // å½“å‰æ’­æ”¾ä½ç½®æœ‰å˜æ›´
          this.tcplayer.on("timeupdate", (e) => {
            // this.isShowTCPlayerPoster("none");
            if (this.liveInfo.liveType == 3) {
              this.recordBroadCastTimeUpdate()
            }
            // console.log(e, "è§†é¢‘timeupdate");
          })

          // è§†é¢‘æ’­æ”¾å·²ç»“æŸæ—¶è§¦å‘
          this.tcplayer.on("ended", (e) => {
            this.isShowTCPlayerPoster("block")
            // this.$emit("envelopeCountDonPause", "è§†é¢‘ended");
            if (this.liveInfo.liveType == 3) {
              this.recordPlayEnded()
            }
            console.log(e, "è§†é¢‘ended")
          })

          // æ’­æ”¾ webrtc æ—¶çš„äº‹ä»¶é›†åˆ
          this.tcplayer.on("webrtcevent", (e) => {
            // console.log(e, "è§†é¢‘webrtcevent", e.data.code)
            // codeç è§æ­¤ï¼šhttps://cloud.tencent.com/document/product/881/30820
            // if ([1001, 1002, 1004, 1005, 1006, 1007, 1008, 1009].includes(e.data.code)) {
            // 	this.$emit("envelopeCountDonPause", "webrtcevent");
            // } else if ([1003, 1010].includes(e.data.code)) {
            // 	this.$emit("envelopeCountDonPlay", "webrtcevent");
            // }
            // console.log("%c Line:353 ğŸ• data.data.code", "color:#6ec1c2", e.data.code);
            if (e.data.code == 1005 && this.playerId) {
              // this.$emit("reloadObsLive", "webrtcevent")
              // const video_div = document.getElementById(this.playerId)
              // video_div.className += " vjs-waiting"
            }
          })

          // è§†é¢‘æ’­æ”¾å‡ºç°é”™è¯¯æ—¶è§¦å‘
          this.tcplayer.on("error", (e) => {
            console.log(e, "è§†é¢‘error")
            this.videoError(e)
          })
        }
      }
      const player = new Player(liveInfo)
      playBtn.addEventListener("click", () => {
        player.tcplayer.play()
      })
      pauseBtn.addEventListener("click", () => {
        player.tcplayer.pause()
      })
    </script>
  </body>
</html>
