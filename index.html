<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link
      href="https://web.sdk.qcloud.com/player/tcplayer/release/v5.1.0/tcplayer.min.css"
      rel="stylesheet"
    />
    <!--播放器脚本文件-->
    <script src="https://tcplayer-1306264703.cos.ap-nanjing.myqcloud.com/tcplayer/test/hls.min.js"></script>
    <script src="https://web.sdk.qcloud.com/player/tcplayer/release/v5.1.0/tcplayer.v5.1.0.min.js"></script>
  </head>
  <body>
    <div>hls拉流测试demo</div>
    <video
      id="player-container-id"
      webkit-playsinline
      playsinline
      style="object-fit: cover"
    ></video>
    <script>
      const liveInfo = {
        answerCount: 3,
        answerDuration: 10,
        answerSwitch: "2",
        answerTimingType: 1,
        blackList: [],
        canRecord: 0,
        chartSwitch: 1,
        countdownSwitch: 1,
        couponModelId: null,
        couponNeedSignNumber: 1,
        couponSwitch: 1,
        coverUrl: "https://h5.huacongjian.cn/default-live-cover.jpeg",
        createTime: "2025-03-28 10:32:46",
        endTime: "2025-04-07 10:14:26",
        envelopNeedSignNumber: 1,
        envelopeStatus: true,
        freeDefineEnvelope: 0,
        heatType: 1,
        id: 1180462,
        imStatus: true,
        initFrequent: 0,
        initVisitor: 0,
        integral: 10,
        integralNeedSignNumber: 1,
        integralSwitch: 1,
        isVertical: 0,
        iscloseOnlineNumber: 0,
        isopen: 1,
        likeSwitch: 1,
        linkTag: 0,
        liveChannelConfig: {
          liveChannelType: null,
          pullType: 2,
          pushType: 1,
        },
        liveConditionTaskRuleList: [],
        liveEnvelope: '[{"liveMinute":1,"amount":0.3}]',
        liveLogo: "https://h5.huacongjian.cn/default-live-cover.jpeg",
        liveNotice: "哈哈哈",
        liveQuestion: null,
        liveStatus: 0,
        liveTagId: 0,
        liveTagName: null,
        liveType: 2,
        materialId: 0,
        maxAnswerCount: 3,
        memberShareRecordSwitch: 0,
        minEnvelopeAmount: 0.1,
        name: "cdn拉流测试-2",
        newLiveQuestionVO: [
          {
            answer: "B",
            answerCount: 3,
            options: [
              {
                label: "A",
                text: "1",
              },
              {
                label: "B",
                text: "1",
              },
              {
                label: "C",
                text: "1",
              },
              {
                label: "D",
                text: "1",
              },
            ],
            questionId: 90,
            questionNo: 1,
            selected: true,
            title: "1",
          },
        ],
        oriCapacity: null,
        passwd: "666",
        peakNumber: null,
        planStartTime: "2025-03-28 10:32:39",
        playCapacity: null,
        preheatingVideoId: 0,
        preheatingVideoName: null,
        preheatingVideoSwitch: 0,
        preheatingVideoUrl: "",
        pullUrl:
          "https://va-eo.qianguolive.cn/testqg/1180462_qg6hd.m3u8?txSecret=bc7b332d302c54e0a22e553aa7f59a67&txTime=67E8AD47",
        punchRelationCouponFlag: 0,
        punchRelationEnvelopFlag: 0,
        punchRelationIntegralFlag: 0,
        punchSwitch: 0,
        punchTimeList: null,
        punchTimes: null,
        pushUrl:
          "rtmp://pushtest.qianguolive.cn/testqg/1180462?txSecret=8f0409ae9981de635290e8338e12872b&txTime=67E8AD47",
        pwdOpen: false,
        questionCount: 1,
        redOf: "1",
        registrationReplayOpen: 0,
        replayCreateTime: null,
        replayDouble: 1,
        replayEndTime: null,
        replayOpen: 0,
        replayParamJson: null,
        replayStartTime: null,
        replayUrl: "",
        replayVideoDuration: null,
        replayVideoSize: null,
        rewardCouponVOList: [
          {
            count: 1,
            couponModelEntity: {
              activityEndTime: "2025-03-26 23:59:59",
              activityStartTime: "2025-03-11 00:00:00",
              backupStatus: 2,
              belongGoodsCategory: null,
              couponGroupId: null,
              createTime: "2025-03-11 23:33:33",
              deleteFlag: 0,
              discount: null,
              enableStartTime: "2025-03-11 00:00:00",
              enableTimeType: 1,
              expireDay: null,
              getLimit: -1,
              giveCount: 21,
              goodsDetailShow: 0,
              id: 1145,
              name: "理发券11",
              overlayRule: "[]",
              overlayUse: 0,
              pause: 0,
              reducedAmount: null,
              remark: "11",
              residueCount: 979,
              status: 4,
              thresholdAmount: 0.0,
              topShopId: 1432201,
              topShopName: "jmh千果总店",
              total: 1000,
              type: 3,
              updateTime: "2025-03-29 11:50:51",
              useDetail: "1.仅能理发\n2.解释权归总店所有",
              useRange: -1,
              userId: 1432201,
              userName: "jmh千果总店",
            },
          },
        ],
        rewardRuleMemberLeveList: null,
        rewardSwitch: 1,
        rewardType: 0,
        sendType: 2,
        shareAgain: 0,
        shareDomain: 1,
        shareOpen: "1",
        shopHoppingSwitch: 0,
        showQuestion: 1,
        showTime: "2025-03-28 10:32:46",
        showTimeType: 1,
        showTopFlag: null,
        signBeepSwitch: 0,
        signDuration: 1,
        startTime: "2025-03-28 10:38:13",
        timePointRewardLifeTime: null,
        timePointRewardRuleList: [],
        topShopId: 1432201,
        topShopName: "jmh千果总店",
        topicQuestion: null,
        updateTime: "2025-04-07 10:14:26",
        userTagIds: [],
        videoLength: null,
        videoName: null,
        visibilityType: 0,
        visibleUserTagName: null,
        whiteList: [],
      }
      class Player {
        constructor(options) {
          this.tcplayer = null
          this.licenseUrl =
            "https://license.vod2.myqcloud.com/license/v2/1327837990_1/v_cube.license"
          // 会员信息
          this.member = {
            memberId: "",
          }
          this.liveInfo = liveInfo
          this.initTCPlayer()
        }
        // hls错误相关处理逻辑
        errorHlsPlay() {}
        // 日志提交
        aegisInfoAll() {}
        // 展示封面逻辑
        isShowTCPlayerPoster() {}
        // tcplayer错误处理逻辑
        videoError() {}
        setTCPlayerUrl() {
          const random = Math.floor(Math.random() * 10000)
          return `${this.liveInfo.pullUrl.split("|")[0]}&randomString=${random}`
        }
        initTCPlayer(type) {
          // TCPlayer的配置参数
          const options = {
            licenseUrl: this.licenseUrl,
            width: 1600,
            height: 900,
            controls: false,
            videoType: "LIVE", // hls 协议直播
            hlsConfig: {
              maxBufferLength: 3, // 将缓冲时长设置为 3 秒
              maxBufferSize: 20 * 1024 * 1024, // 缓冲区大小设置为 20MB，避免缓存过多导致延迟
              maxMaxBufferLength: 5, // 最大缓冲时长上限设置为 5 秒
              liveSyncDurationCount: 0, // 同步到直播边缘的时长（使用最新分片的数量），建议设置为 1
              maxLiveSyncPlaybackRate: 0,
              enableWorker: true,
              lowLatencyMode: true, // 启用低延迟模式，确保播放器处理低延迟流
            },
            poster: this.liveInfo.coverUrl,
            webrtcConfig: {
              connectRetryCount: 5,
              connectRetryDelay: 0,
              showLog: true,
            },
            src: [{ src: this.setTCPlayerUrl() }],
          }
          // 初始化播放器
          this.tcplayer = TCPlayer(`player-container-id`, options)
          console.log(this.tcplayer, "创建播放器")

          // 当播放器能够开始播放视频时触发
          this.tcplayer.on("canplay", (e) => {
            this.isShowTCPlayerPoster("block")
            console.log(e, "视频canplay")
          })

          // 开始加载数据时触发
          this.tcplayer.on("loadstart", (e) => {
            this.isShowTCPlayerPoster("block")
            console.log(e, "视频loadstart")
          })

          // 已加载视频的 metadata
          this.tcplayer.on("loadedmetadata", (e) => {
            // this.isShowTCPlayerPoster("block");
            console.log(e, "视频loadedmetadata")
            this.checkQualityInterval()
          })

          // 暂停时触发
          this.tcplayer.on("pause", (e) => {
            console.log(e, "视频pause")
            this.isPlaying = false
            this.aegisInfoAll(
              "OBS视频--播放暂停：",
              {
                ["类型"]: e.type,
                ["信息"]: "播放暂停",
              },
              this.member.memberId
            )
          })

          // 播放停止，下一帧内容不可用时触发
          this.tcplayer.on("waiting", (e) => {
            console.log(e, "视频waiting")
            if (!this.liveInfo.pullUrl.startsWith("http")) return
            clearTimeout(this.waitingTimer)
            this.waitingTimer = setTimeout(() => {
              !this.isPlaying && this.errorHlsPlay()
            }, 10000)
          })

          // 开始播放，画面并没有开始渲染
          this.tcplayer.on("play", (e) => {
            console.log(e, "视频play")
            this.aegisInfoAll(
              "OBS视频--开始播放：",
              {
                ["信息"]: "开始播放",
                ["playerId"]: this.playerId,
                ["TCPlayer参数"]: options,
              },
              this.member.memberId
            )
          })

          // 因缓冲而暂停或停止后恢复播放时触发
          this.tcplayer.on("playing", (e) => {
            this.isShowTCPlayerPoster("none")
            this.$emit("envelopeCountDonPlay", "视频")
            console.log(e, "视频playing")
            this.isPlaying = true
            this.iShowObsPlayBtn = false // 隐藏播放按钮
            // this.aegisInfoAll('OBS视频--恢复播放：', {
            // 	['信息']: '恢复播放'
            // }, this.member.memberId);
          })

          // 当前播放位置有变更
          this.tcplayer.on("timeupdate", (e) => {
            // this.isShowTCPlayerPoster("none");
            if (this.liveInfo.liveType == 3) {
              this.recordBroadCastTimeUpdate()
            }
            // console.log(e, "视频timeupdate");
          })

          // 视频播放已结束时触发
          this.tcplayer.on("ended", (e) => {
            this.isShowTCPlayerPoster("block")
            // this.$emit("envelopeCountDonPause", "视频ended");
            if (this.liveInfo.liveType == 3) {
              this.recordPlayEnded()
            }
            console.log(e, "视频ended")
          })

          // 播放 webrtc 时的事件集合
          this.tcplayer.on("webrtcevent", (e) => {
            // console.log(e, "视频webrtcevent", e.data.code)
            // code码见此：https://cloud.tencent.com/document/product/881/30820
            // if ([1001, 1002, 1004, 1005, 1006, 1007, 1008, 1009].includes(e.data.code)) {
            // 	this.$emit("envelopeCountDonPause", "webrtcevent");
            // } else if ([1003, 1010].includes(e.data.code)) {
            // 	this.$emit("envelopeCountDonPlay", "webrtcevent");
            // }
            // console.log("%c Line:353 🍕 data.data.code", "color:#6ec1c2", e.data.code);
            if (e.data.code == 1005 && this.playerId) {
              this.$emit("reloadObsLive", "webrtcevent")
              const video_div = document.getElementById(this.playerId)
              video_div.className += " vjs-waiting"
            }
          })

          // 视频播放出现错误时触发
          this.tcplayer.on("error", (e) => {
            console.log(e, "视频error")
            this.videoError(e)
          })
        }
      }
      const player = new Player(liveInfo)
    </script>
  </body>
</html>
